恢复操作的基本原理：冗余
利用存储在系统其它地方的冗余数据来重建数据库中已
破坏或者不正确的那部分数据




如何建立冗余数据


数据转储

登录日志文件


转储是指DBA将整个数据库复制到磁带或另一个磁盘上保存起来的过程。

这些备用的数据文本成为后备副本或后援副本



如何使用

数据库遭到破坏后可以将后备副本重新装入

重装后后背副本只能将数据库恢复到转储时的状态



转存状态   静态转储  动态转储   海量转储  增量转储


利用动态转储得到的副本进行故障恢复

需要把动态转储期间各事务对数据库的修改活动登记下来，建立日志文件

后备副本加上日志文件才能把数据库恢复到某一时刻的正确状态

使用海量转储得到的后备副本进行恢复往往更方便


事务  Transaction  一个数据库操作序列  一个不可分割的工作单位 恢复和并发控制的基本单位



日志文件 log 是用来记录事务对数据库的更新操作的文件 

日志文件的格式

以记录为单位的日志文件

以数据块为单位的日志文件



以数据块为单位的日志文件，每条日志记录的内容

事务标识

被更新的数据块


日志文件的作用

进行事物故障恢复

进行系统故障恢复

协助后备副本进行介质故障恢复


登录日志文件的基本原则

登记的次序严格按并行事务执行的时间次序

必须先写日志文件，后写数据库

系统故障的恢复由系统在重新启动时自动完成，不需要用户干预


系统故障的恢复步骤

1. 正向扫描日志文件（即从头扫描日志文件）

  重做 REDO 队列： 在故障发生前已提交的事物

  撤销 UNDO 队列： 故障发生前尚未完成     无COMMIT记录


先 反向UNDO   再正向REDO


介质故障的恢复


重装数据库

重做已完成的事务

1 装入最新的  后备数据库副本  离故障发生时刻最近的转储副本  使数据库恢复到最近一次转储时的一致性状态

对于静态转储的数据库副本，装入后数据库即处于一致性状态

对于动态转储的数据库副本，还须同时装入转储时刻的日志文件副本，利用
与恢复系统故障的方法  REDO + UNDO  才能将数据库恢复到一致性状态。

装入有关的 日志文件副本


介质故障的恢复需要DBA介入

DBA的工作

重装最近转储的数据库副本和有关的各日志文件副本

执行系统提供的恢复命令


具体的恢复操作仍由DBMS完成

完整备份  差异备份  事务日志备份（备份T-SQL语句）


完整+事务日志备份与还原  完整备份时间过长


检查点记录的内容


建立检查点时刻所有正在执行的事务清单

这些事务最近一个日志记录的地址

重新开始文件的内容
记录各个检查点记录在日志文件中的地址

动态维护日志文件的方法

周期性地执行如下操作

建立检查点，保存数据库状态

在实际应用中用户往往只选择对 关键数据 和 日志文件 镜像，
而不是对整个数据库进行镜像。


2NF  插入异常  删除异常   数据冗余度大   修改复杂等问题


























